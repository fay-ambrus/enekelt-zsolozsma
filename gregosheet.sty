\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{gregosheet}[2025/01/01 Custom sheet music]

\RequirePackage{fontspec}
\RequirePackage{luacode}
\RequirePackage{xparse}

% Load Lua module
\directlua{require("gregosheet")}

% Load fonts (user-defined)
\newfontfamily\MusicFont{guidohu_.ttf}
\newfontfamily\LyricsFont{Cambria}

% Capture font IDs in Lua
{\MusicFont\fontsize{20}{24}\selectfont
  \directlua{gregosheet.music_fontid = font.current()}
}
{\LyricsFont\fontsize{10}{12}\selectfont
  \directlua{gregosheet.lyrics_fontid = font.current()}
}

% Internal storage and commands
\ExplSyntaxOn
\tl_new:N \g_gregosheet_melody_tl
\tl_new:N \g_gregosheet_lyrics_tl

\NewDocumentCommand{\melody}{m}{
  \tl_gset:Nn \g_gregosheet_melody_tl {#1}
}

\NewDocumentCommand{\lyrics}{m}{
  \tl_gset:Nn \g_gregosheet_lyrics_tl {#1}
}

\NewDocumentEnvironment{gregosheet}{}{
  % begin
  \catcode`\_=12
  \catcode`\^=12
  \catcode`\$=12
}{
  % end: call Lua main function
  \directlua{
    gregosheet.render(
      "\luaescapestring{\tl_use:N \g_gregosheet_melody_tl}",
      "\luaescapestring{\tl_use:N \g_gregosheet_lyrics_tl}"
    )
  }
}
\ExplSyntaxOff