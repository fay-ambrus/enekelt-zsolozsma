\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{gregosheet}[2025/01/01 Custom sheet music]

\RequirePackage{fontspec}
\RequirePackage{luacode}
\RequirePackage{xparse}

% Load Lua module
\directlua{require("gregosheet")}

% Load music font (replace with your actual font)
\newfontfamily\MusicFont{guidohu_.ttf}

% Internal storage and commands
\ExplSyntaxOn
\tl_new:N \g_gregosheet_melody_tl
\tl_new:N \g_gregosheet_lyrics_tl

\NewDocumentCommand{\melody}{m}{
  \tl_gset:Nn \g_gregosheet_melody_tl {#1}
}

\NewDocumentCommand{\lyrics}{m}{
  \tl_gset:Nn \g_gregosheet_lyrics_tl {#1}
}

\NewDocumentEnvironment{gregosheet}{}{
  % begin
}{
  % end: call Lua renderer
  \directlua{
    gregosheet.render(
      "\luaescapestring{\tl_use:N \g_gregosheet_melody_tl}",
      "\luaescapestring{\tl_use:N \g_gregosheet_lyrics_tl}"
    )
  }
}
\ExplSyntaxOff
