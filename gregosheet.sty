\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{gregosheet}[2025/01/01 Custom sheet music]

\RequirePackage{fontspec}
\RequirePackage{luacode}
\RequirePackage{xparse}

% Load Lua module
\directlua{
  require("gregosheet/gregosheet.common")
  require("gregosheet/gregosheet.parser")
  require("gregosheet/gregosheet.spacing")
  require("gregosheet/gregosheet.render")
  require("gregosheet/gregosheet.main")
}

% Load fonts (user-defined)
\newfontfamily\MusicFont{guidohu_.ttf}

% Capture font IDs in Lua
{\MusicFont\fontsize{20}{24}\selectfont
  \directlua{gregosheet.music_fontid = font.current()}
}
% Lyric font ID will be captured after \lyricfont is defined by user

% Internal storage and commands
\ExplSyntaxOn
\tl_new:N \g_gregosheet_melody_tl
\tl_new:N \g_gregosheet_lyrics_tl

\NewDocumentCommand{\melody}{m}{
  \tl_gset:Nn \g_gregosheet_melody_tl {#1}
}

\NewDocumentCommand{\lyrics}{m}{
  \tl_gset:Nn \g_gregosheet_lyrics_tl {#1}
}

\NewDocumentEnvironment{gregosheet}{}{
  % begin
  \vskip\blockvskip
  \catcode`\_=12
  \catcode`\^=12
  \catcode`\$=12
  % Capture lyric font ID after user styles are loaded
  {\lyricfont\fontsize{10}{12}\selectfont
    \directlua{gregosheet.lyrics_fontid = font.current()}
  }
}{
  % end: call Lua main function
  \directlua{
    gregosheet.main(
      "\luaescapestring{\tl_use:N \g_gregosheet_melody_tl}",
      "\luaescapestring{\tl_use:N \g_gregosheet_lyrics_tl}"
    )
  }
}
\ExplSyntaxOff
